name: Daily Container Check

on:
  schedule:
    - cron: '*/2 * * * *'  # –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
  workflow_dispatch:

env:
  TELEGRAM_TO: -1003170352623
  CONTAINER_NAME: "bot-ebal-nahui"

jobs:
  container-health-check:
    runs-on: ubuntu-latest
    steps:
      # –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —à–∞–≥
      - name: Debug info
        run: |
          echo "üöÄ Workflow –∑–∞–ø—É—â–µ–Ω!"
          echo "Event: ${{ github.event_name }}"
          echo "Time: $(date)"
          
      - name: Check container via SSH
        id: container-check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30s
          script: |
            echo "‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫ $(hostname)"
            CONTAINER="${{ env.CONTAINER_NAME }}"
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $CONTAINER"
            
            # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
            if docker ps | grep -q "$CONTAINER"; then
              echo "status=running" >> $GITHUB_OUTPUT
              echo "details=‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω" >> $GITHUB_OUTPUT
            else
              echo "status=stopped" >> $GITHUB_OUTPUT
              echo "details=‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" >> $GITHUB_OUTPUT
            fi

      - name: Send Telegram report
        if: always()  # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          message: |
            üìä –û–¢–ß–ï–¢ –ü–†–û–í–ï–†–ö–ò
            
            –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${{ env.CONTAINER_NAME }}
            –°—Ç–∞—Ç—É—Å: ${{ steps.container-check.outputs.status || 'unknown' }}
            –î–µ—Ç–∞–ª–∏: ${{ steps.container-check.outputs.details || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏' }}
            
            –í—Ä–µ–º—è: ${{ fromJSON('{"date": "'$(date +"%H:%M:%S")'"}').date }}
            –¢–∏–ø: ${{ github.event_name == 'schedule' && '–ê–≤—Ç–æ' : '–†—É—á–Ω–æ–π' }}