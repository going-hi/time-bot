name: Container Health Check

on:
  workflow_dispatch:

env:
  TELEGRAM_TO: -1003170352623
  CONTAINER_NAME: "bot-ebal-nahui"

jobs:
  check-container:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ½Ğ° ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ
      - name: Check container status on remote server
        id: check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: false
          script: |
            CONTAINER="${{ env.CONTAINER_NAME }}"
            echo "ğŸ” Checking container: $CONTAINER"

            if ! docker inspect "$CONTAINER" >/dev/null 2>&1; then
              RESULT="not_found|âŒ Container $CONTAINER does not exist"
            else
              STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER")
              if [ "$STATUS" = "running" ]; then
                STARTED_AT=$(docker inspect --format='{{.State.StartedAt}}' "$CONTAINER")
                RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' "$CONTAINER")
                RESULT="running|ğŸŸ¢ Running | Restarts: $RESTART_COUNT | Started: $STARTED_AT"
              else
                EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' "$CONTAINER")
                RESULT="stopped|ğŸ”´ Stopped | Exit Code: $EXIT_CODE"
              fi
            fi

            # ğŸ‘‰ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² Ñ„Ğ°Ğ¹Ğ», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ·Ğ¶Ğµ
            echo "$RESULT" > result.txt

            # ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° Ñ…Ğ¾ÑÑ‚ runner'Ğ°
            cat result.txt

      # 2ï¸âƒ£ Ğ—Ğ°Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¸ Ğ¿Ğ°Ñ€ÑĞ¸Ğ¼ ĞµĞ³Ğ¾
      - name: Parse container status
        id: parse
        run: |
          result=$(cat result.txt)
          echo "Raw line: $result"
          status=$(echo "$result" | cut -d'|' -f1)
          details=$(echo "$result" | cut -d'|' -f2-)
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "details=$details" >> $GITHUB_OUTPUT

      # 3ï¸âƒ£ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ (ĞœĞ¡Ğš)
      - name: Get current time (Moscow)
        id: time
        run: |
          export TZ="Europe/Moscow"
          now=$(date +"%d %B %Y, %H:%M (%Z)")
          echo "time=$now" >> $GITHUB_OUTPUT

      # 4ï¸âƒ£ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ² Telegram
      - name: Send Telegram report
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ğŸ“Š *ĞĞ¢Ğ§ĞĞ¢ Ğ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ•*

            ğŸ³ *Ğ˜Ğ¼Ñ:* `${{ env.CONTAINER_NAME }}`
            ğŸš€ *Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:* `${{ steps.parse.outputs.status }}`
            ğŸ“ *Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸:* ${{ steps.parse.outputs.details }}

            ğŸ•’ *Ğ’Ñ€ĞµĞ¼Ñ:* ${{ steps.time.outputs.time }}
            ğŸ”— [ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})