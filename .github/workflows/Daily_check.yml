name: Container Health Check

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

env:
  TELEGRAM_TO: -1003170352623
  CONTAINER_NAME: "bot-ebal-nahui"

jobs:
  check-container:
    runs-on: ubuntu-latest

    steps:
      - name: Check container status on remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30s
          script_stop: true
          script: |
            CONTAINER="${{ env.CONTAINER_NAME }}"
            OUTPUT_FILE="/tmp/container_status.txt"
            echo "🔍 Checking container: $CONTAINER"

            if ! docker inspect "$CONTAINER" >/dev/null 2>&1; then
              echo "not_found|❌ Container $CONTAINER does not exist" > $OUTPUT_FILE
              exit 0
            fi

            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER")

            if [ "$STATUS" = "running" ]; then
              STARTED_AT=$(docker inspect --format='{{.State.StartedAt}}' "$CONTAINER")
              RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' "$CONTAINER")
              echo "running|🟢 Running | Restarts: $RESTART_COUNT | Started: $STARTED_AT" > $OUTPUT_FILE
            else
              EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' "$CONTAINER")
              echo "stopped|🔴 Stopped | Exit Code: $EXIT_CODE" > $OUTPUT_FILE
            fi

      - name: Download container status result
        id: fetch
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "/tmp/container_status.txt"
          target: "./"

      - name: Parse container status
        id: parse
        run: |
          line=$(cat container_status.txt)
          status=$(echo "$line" | cut -d'|' -f1)
          details=$(echo "$line" | cut -d'|' -f2-)
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "details=$details" >> $GITHUB_OUTPUT

      - name: Get current time (Moscow)
        id: time
        run: |
          export TZ="Europe/Moscow"
          now=$(date +"%d %B %Y, %H:%M (%Z)")
          echo "time=$now" >> $GITHUB_OUTPUT

      - name: Send Telegram report
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          message: |
            📊 ОТЧЕТ О КОНТЕЙНЕРЕ

            🐳 Имя: ${{ env.CONTAINER_NAME }}
            🚀 Статус: ${{ steps.parse.outputs.status }}
            📝 Детали: ${{ steps.parse.outputs.details }}

            🕒 Время: ${{ steps.time.outputs.time }}
