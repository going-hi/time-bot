name: Container Health Check

on:
  workflow_dispatch:

env:
  TELEGRAM_TO: -1003170352623
  CONTAINER_NAME: "bot-ebal-nahui"

jobs:
  check-container:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ½Ğ° ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½Ğ½Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ
      - name: Check container status on remote server
        id: check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: false
          script: |
            CONTAINER="${{ env.CONTAINER_NAME }}"
            REPORT="/tmp/container_status.txt"
            RESULT_FILE="/tmp/result.txt"

            echo "ğŸ” Checking container: $CONTAINER" > "$REPORT"

            if ! docker inspect "$CONTAINER" >/dev/null 2>&1; then
              echo "âŒ Container not found" >> "$REPORT"
              RESULT="not_found|âŒ Container $CONTAINER does not exist"
            else
              STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER")
              echo "Status: $STATUS" >> "$REPORT"
              echo "Details:" >> "$REPORT"
              docker inspect "$CONTAINER" | head -n 30 >> "$REPORT"
              
              if [ "$STATUS" = "running" ]; then
                docker logs --tail 20 "$CONTAINER" >> "$REPORT" 2>&1
                RESULT="running|ğŸŸ¢ Container is running"
              else
                RESULT="stopped|ğŸ”´ Container is stopped"
              fi
            fi

            echo "$RESULT" > "$RESULT_FILE"

      # 2ï¸âƒ£ Ğ¡Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¿Ğ¾ SSH
      - name: Get result from server manually
        id: get_result
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: false
          script: |
            echo "output_start"
            cat /tmp/result.txt
            echo "output_end"

      # 3ï¸âƒ£ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾
      - name: Save result to file
        run: |
          echo "${{ steps.get_result.outputs.output }}" | \
            sed -n '/output_start/,/output_end/{//!p;}' > result.txt

      # 4ï¸âƒ£ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ ĞºĞ°Ğº Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚
      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-status
          path: result.txt

      # 5ï¸âƒ£ Ğ Ğ°Ğ·Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
      - name: Parse container status
        id: parse
        run: |
          line=$(cat result.txt || echo "unknown|no result")
          status=$(echo "$line" | cut -d'|' -f1)
          details=$(echo "$line" | cut -d'|' -f2-)
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "details=$details" >> $GITHUB_OUTPUT

      # 6ï¸âƒ£ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ (ĞœĞ¾ÑĞºĞ²Ğ°)
      - name: Get current time (Moscow)
        id: time
        run: |
          export TZ="Europe/Moscow"
          now=$(date +"%d %B %Y, %H:%M (%Z)")
          echo "time=$now" >> $GITHUB_OUTPUT

      # 7ï¸âƒ£ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
      - name: Notify if container is running
        if: ${{ steps.parse.outputs.status == 'running' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            âœ… *ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!*
            ğŸ³ *Ğ˜Ğ¼Ñ:* `${{ env.CONTAINER_NAME }}`
            ğŸŸ¢ ${{ steps.parse.outputs.details }}
            ğŸ•’ *Ğ’Ñ€ĞµĞ¼Ñ:* ${{ steps.time.outputs.time }}
            ğŸ“„ [ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ² Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ… GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Notify if container is stopped or not found
        if: ${{ steps.parse.outputs.status != 'running' }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            âš ï¸ *ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!*
            ğŸ³ *Ğ˜Ğ¼Ñ:* `${{ env.CONTAINER_NAME }}`
            ğŸ”´ ${{ steps.parse.outputs.details }}
            ğŸ•’ *Ğ’Ñ€ĞµĞ¼Ñ:* ${{ steps.time.outputs.time }}
            ğŸ“„ [ĞÑ‚Ñ‡Ñ‘Ñ‚ Ğ² Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ… GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
