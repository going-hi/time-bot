name: Container Health Check

on:
  schedule:
    - cron: '*/5 * * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  workflow_dispatch:

env:
  TELEGRAM_TO: -1003170352623
  CONTAINER_NAME: "bot-ebal-nahui"

jobs:
  check-container:
    runs-on: ubuntu-latest
    steps:
      - name: Check container status
        id: container-check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}  # âœ… Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½ĞµĞµ, Ñ‡ĞµĞ¼ password
          timeout: 30s
          script_stop: true
          script: |
            CONTAINER="${{ env.CONTAINER_NAME }}"
            echo "ğŸ” Checking container: $CONTAINER"

            if ! docker inspect "$CONTAINER" >/dev/null 2>&1; then
              echo "not_found|âŒ Container $CONTAINER does not exist"
              exit 0
            fi

            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER")

            if [ "$STATUS" = "running" ]; then
              STARTED_AT=$(docker inspect --format='{{.State.StartedAt}}' "$CONTAINER")
              RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' "$CONTAINER")
              echo "running|ğŸŸ¢ Running | Restarts: $RESTART_COUNT | Started: $STARTED_AT"
            else
              EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' "$CONTAINER")
              echo "stopped|ğŸ”´ Stopped | Exit Code: $EXIT_CODE"
            fi

      - name: Parse SSH output
        id: parse
        run: |
          output="${{ steps.container-check.outputs.output }}"
          status=$(echo "$output" | head -n1 | cut -d'|' -f1)
          details=$(echo "$output" | head -n1 | cut -d'|' -f2-)
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "details=$details" >> $GITHUB_OUTPUT

      - name: Get current time (Moscow)
        id: time
        run: |
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ·Ğ¾Ğ½Ñƒ ĞœĞ¡Ğš (UTC+3)
          export TZ="Europe/Moscow"
          now=$(date +"%d %B %Y, %H:%M (%Z)")
          echo "time=$now" >> $GITHUB_OUTPUT

      - name: Send Telegram report
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          message: |
            ğŸ“Š ĞĞ¢Ğ§Ğ•Ğ¢ Ğ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ•

            ğŸ³ Ğ˜Ğ¼Ñ: ${{ env.CONTAINER_NAME }}
            ğŸš€ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${{ steps.parse.outputs.status }}
            ğŸ“ Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸: ${{ steps.parse.outputs.details }}

            ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ: ${{ steps.time.outputs.time }}