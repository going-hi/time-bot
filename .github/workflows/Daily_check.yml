name: Container Health Check

on:
  schedule:
    - cron: '*/5 * * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  workflow_dispatch:        # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

env:
  TELEGRAM_TO: -1003170352623
  CONTAINER_NAME: "bot-ebal-nahui"

jobs:
  check-container:
    runs-on: ubuntu-latest
    steps:
      # Ğ¨Ğ°Ğ³ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ñ‡ĞµÑ€ĞµĞ· SSH
      - name: Check container status
        id: container-check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30s
          script: |
            CONTAINER="${{ env.CONTAINER_NAME }}"
            echo "ğŸ” Checking container: $CONTAINER"
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            if ! docker inspect "$CONTAINER" >/dev/null 2>&1; then
              echo "âŒ Container not found"
              echo "status=not_found" >> $GITHUB_OUTPUT
              echo "details=Container $CONTAINER does not exist" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            STATUS=$(docker inspect --format='{{.State.Status}}' "$CONTAINER")
            
            if [ "$STATUS" = "running" ]; then
              STARTED_AT=$(docker inspect --format='{{.State.StartedAt}}' "$CONTAINER")
              UPTIME=$(docker inspect --format='{{.State.Status}} since {{.State.StartedAt}}' "$CONTAINER")
              RESTART_COUNT=$(docker inspect --format='{{.RestartCount}}' "$CONTAINER")
              
              echo "âœ… Container is running"
              echo "status=running" >> $GITHUB_OUTPUT
              echo "details=ğŸŸ¢ Running | Restarts: $RESTART_COUNT | Started: $STARTED_AT" >> $GITHUB_OUTPUT
            else
              EXIT_CODE=$(docker inspect --format='{{.State.ExitCode}}' "$CONTAINER")
              echo "âŒ Container is stopped"
              echo "status=stopped" >> $GITHUB_OUTPUT
              echo "details=ğŸ”´ Stopped | Exit Code: $EXIT_CODE" >> $GITHUB_OUTPUT
            fi
            
            # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
            echo "--- System Info ---"
            docker system df
            echo ""
            echo "--- Running Containers ---"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"

      - name: Get current time
        id: time
        run: echo "time=$(date -Iseconds)" >> $GITHUB_OUTPUT

      - name: Send Telegram report
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_TO }}
          token: ${{ secrets.BOT_TOKEN }}
          message: |
            ğŸ“Š ĞĞ¢Ğ§Ğ•Ğ¢ Ğ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ•
            
            ğŸ³ Ğ˜Ğ¼Ñ: ${{ env.CONTAINER_NAME }}
            ğŸš€ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${{ steps.container-check.outputs.status }}
            ğŸ“ Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸: ${{ steps.container-check.outputs.details }}
            
            ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ: ${{ steps.time.outputs.time }}